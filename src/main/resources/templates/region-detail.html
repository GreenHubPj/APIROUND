<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ìƒì„¸ - GreenHub</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/region-detail.css}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<!-- í—¤ë” include -->
<div th:replace="common/header :: header"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<main class="main-content">
    <div class="container">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <div class="back-button">
            <button class="back-btn" id="backBtn" onclick="history.back()">
                <span>â†</span> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

        <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
        <div class="main-layout">
            <!-- ì™¼ìª½: ìƒí’ˆ ì´ë¯¸ì§€, ë¦¬ë·°, ì—…ì²´ ì •ë³´ -->
            <div class="left-section">
                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                <div class="product-images">
                    <div class="thumbnail-container" id="thumbnailContainer">
                        <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="main-image-container">
                        <img id="mainImage" th:src="${product.thumbnailUrl}" th:alt="${product.productName}" class="main-image">
                        <div class="image-nav">
                            <button class="nav-btn prev-btn" id="prevBtn">â€¹</button>
                            <button class="nav-btn next-btn" id="nextBtn">â€º</button>
                        </div>
                    </div>
                </div>

                <!-- ë¦¬ë·° ì„¹ì…˜ -->
                <div class="review-section"
                     th:attr="data-product-id=${product.productId}">
                    <div class="review-header">
                        <h2 class="section-title">ê³ ê° ë¦¬ë·°</h2>
                        <a class="view-all-reviews-btn" th:href="@{'/products/' + ${product.productId} + '/reviews'}">ë¦¬ë·°ë³´ê¸°</a>
                    </div>
                    <div class="review-list" id="reviewList">
                        <!-- ë¦¬ë·° ë¯¸ë¦¬ë³´ê¸°(ìµœì‹  3ê°œ)ê°€ ì—¬ê¸° ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì—…ì²´ ì •ë³´ ì„¹ì…˜ -->
                <div class="company-section">
                    <h3 class="company-title">ì—…ì²´ ì •ë³´</h3>
                    <div class="company-details">
                        <div class="company-item">
                            <span class="company-label">ì—…ì²´ëª…:</span>
                            <span class="company-value" id="companyName">ë¬¸ê²½ë†í˜‘</span>
                        </div>
                        <div class="company-item">
                            <span class="company-label">ì „í™”ë²ˆí˜¸:</span>
                            <span class="company-value" id="companyPhone">054-555-1234</span>
                        </div>
                        <div class="company-item">
                            <span class="company-label">ì´ë©”ì¼:</span>
                            <span class="company-value" id="companyEmail">mungyeong@coop.co.kr</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì •ë³´ -->
            <div class="right-section">
                <div class="product-info">
                    <div class="product-header">
                        <h1 class="product-title" id="productTitle" th:text="${product.productName}">ìƒí’ˆëª…</h1>
                        <div class="product-tags" id="productTags">
                            <span class="product-tag" th:text="${product.productType}">ì¹´í…Œê³ ë¦¬</span>
                            <span class="product-tag" th:text="${product.regionText}">ì§€ì—­</span>
                        </div>
                    </div>

                    <div class="product-price-section">
                        <h3 class="price-title">ê°€ê²© ì˜µì…˜</h3>
                        <div class="price-options" id="priceOptions">
                            <!-- ê°€ê²© ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <div class="product-details">
                        <div class="detail-item">
                            <span class="detail-label">ì›ì‚°ì§€:</span>
                            <span class="detail-value" id="originInfo" th:text="${product.regionText}">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ì œì² ê¸°ê°„:</span>
                            <span class="detail-value" id="seasonInfo" th:text="${product.harvestSeason}">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ìƒí’ˆ ìœ í˜•:</span>
                            <span class="detail-value" id="typeInfo" th:text="${product.productType}">-</span>
                        </div>
                    </div>

                    <div class="product-description">
                        <h3 class="description-title">ìƒí’ˆ ì„¤ëª…</h3>
                        <p class="description-text" id="descriptionText" th:text="${product.description}">ìƒí’ˆ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>

                    <div class="purchase-section">
                        <div class="quantity-selector">
                            <label for="quantity">ìˆ˜ëŸ‰ ì„ íƒ:</label>
                            <div class="quantity-controls">
                                <button class="quantity-btn" id="decreaseBtn">-</button>
                                <input type="number" id="quantity" value="1" min="1" class="quantity-input">
                                <button class="quantity-btn" id="increaseBtn">+</button>
                            </div>
                        </div>
                        <div class="price-option-selector">
                            <label for="priceOptionSelect">ê°€ê²© ì˜µì…˜:</label>
                            <select id="priceOptionSelect" class="price-select">
                                <option value="">ê°€ê²© ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div class="total-price">
                            <span class="total-label">ì´ ê°€ê²©:</span>
                            <span class="total-amount" id="totalAmount">0ì›</span>
                        </div>
                        <div class="purchase-buttons">
                            <button class="btn-cart" id="addToCartBtn">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                            <button class="btn-buy" id="buyNowBtn">ğŸ’³ êµ¬ë§¤í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ë ¨ ìƒí’ˆ ì„¹ì…˜ -->
        <div class="related-products-section">
            <h2 class="section-title">ê´€ë ¨ ìƒí’ˆ</h2>
            <div class="related-products-grid" id="relatedProductsGrid">
                <!-- ê´€ë ¨ ìƒí’ˆë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
</main>

<!-- í‘¸í„° include -->
<div th:replace="common/footer :: footer"></div>

<!-- ê¸°ì¡´ ìƒì„¸ JS -->
<script th:src="@{/js/region-detail.js}"></script>

<!-- ë¦¬ë·° ë¯¸ë¦¬ë³´ê¸° ì „ìš© ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    (function(){
        const root = document.querySelector('.review-section');
        if (!root) return;

        const productId = root.getAttribute('data-product-id');
        const listEl = document.getElementById('reviewList');

        function maskStars(n) {
            const full = 'â˜…'.repeat(n);
            const empty = 'â˜†'.repeat(5 - n);
            return full + empty;
        }
        function fmtDate(iso) {
            try {
                const d = new Date(iso);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth()+1).padStart(2,'0');
                const dd = String(d.getDate()).padStart(2,'0');
                return `${yyyy}.${mm}.${dd}`;
            } catch(e) {
                return '';
            }
        }
        function render(items){
            if (!items || items.length === 0) {
                listEl.innerHTML = '<div class="review-empty">ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            listEl.innerHTML = items.map(rv => `
                <div class="review-item">
                    <div class="review-top">
                        <div class="review-author">${rv.authorName ?? 'ìµëª…'}</div>
                        <div class="review-date">${fmtDate(rv.createdAt)}</div>
                    </div>
                    <div class="review-rating">${maskStars(rv.rating)}</div>
                    <div class="review-content">${(rv.content ?? '').replace(/\n/g,'<br>')}</div>
                </div>
            `).join('');
        }

        fetch(`/api/products/${productId}/reviews/preview?page=0&size=3`)
            .then(r => r.json())
            .then(data => render(data.content))
            .catch(() => { listEl.innerHTML = '<div class="review-empty">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'; });
    })();
</script>
</body>
</html>
