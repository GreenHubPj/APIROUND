<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>리뷰 작성 - GreenHub</title>

    <!-- ※ 시큐리티/CSRF 미사용: _csrf 메타 태그 제거 -->

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/review-write.css}" />

    <style>
        .container{max-width:1040px;margin:0 auto;padding:24px}
        .product-info-section{display:flex;gap:20px;margin-bottom:24px}
        .product-img{width:140px;height:140px;object-fit:cover;border-radius:12px;border:1px solid #eee}
        .product-info h1{margin:0 0 8px;font-size:22px}
        .product-price{margin-top:6px;color:#555}
        .review-textarea{width:100%;min-height:160px;padding:14px;border:1px solid #007bff;border-radius:10px}
        .textarea-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .save-btn{padding:.6rem 1.2rem;border-radius:10px;border:0;background:#007bff;color:#fff;cursor:pointer}
        .save-btn:disabled{opacity:.6;cursor:not-allowed}
        .star{font-size:24px;cursor:pointer;opacity:.35;user-select:none}
        .star.active{opacity:1}
        .error-box{background:#fff4f4;border:1px solid #ffd4d4;color:#b30000;padding:12px;border-radius:10px;margin:12px 0}
        .hint{color:#6c757d;margin:4px 0 0}
        .form-error{color:#b30000;margin-top:8px;display:none}
        .back-link{display:inline-block;margin:4px 0 16px;color:#1a73e8;text-decoration:none}
    </style>
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<main class="container"
      th:attr="data-order-item-id=${orderItemId}, data-product-id=${productId}">
    <a class="back-link" href="/review">← 리뷰 목록으로</a>

    <!-- 서버에서 온 에러(권한/조건 불일치 등) -->
    <div class="error-box" th:if="${errorMessage != null}" th:text="${errorMessage}">
        권한이 없거나 대상이 없습니다.
    </div>

    <section class="product-info-section" th:if="${errorMessage == null}">
        <div>
            <img class="product-img"
                 th:src="${productImage != null ? productImage : '/images/농산물.png'}"
                 th:alt="${productName != null ? productName : '상품 이미지'}"
                 alt="상품 이미지" />
        </div>
        <div class="product-info">
            <div class="store-brand" th:text="${storeName != null ? storeName : '스토어'}">스토어</div>
            <h1 class="product-name" th:text="${productName != null ? productName : '상품명'}">상품명</h1>
            <div class="product-price" th:text="${priceText != null ? priceText : ''}">-</div>
            <div class="hint" th:if="${deliveredAt != null}"
                 th:text="${'배송완료: ' + #temporals.format(deliveredAt, 'yyyy-MM-dd HH:mm')}">배송완료</div>
        </div>
    </section>

    <section class="review-write-section" th:if="${errorMessage == null}">
        <div class="satisfaction-section" aria-labelledby="ratingLabel">
            <h2 id="ratingLabel">상품 만족도</h2>
            <div class="star-rating" role="radiogroup" aria-label="별점 선택">
                <span class="star" data-rating="1" role="radio" aria-checked="false" aria-label="1점">★</span>
                <span class="star" data-rating="2" role="radio" aria-checked="false" aria-label="2점">★</span>
                <span class="star" data-rating="3" role="radio" aria-checked="false" aria-label="3점">★</span>
                <span class="star" data-rating="4" role="radio" aria-checked="false" aria-label="4점">★</span>
                <span class="star" data-rating="5" role="radio" aria-checked="false" aria-label="5점">★</span>
            </div>
            <input type="hidden" id="ratingValue" value="0" />
            <div class="form-error" id="ratingError">별점을 선택해 주세요.</div>
        </div>

        <div class="review-content-section">
            <h2>리뷰 작성</h2>
            <div class="review-textarea-container">
                <textarea id="reviewTextarea" class="review-textarea" maxlength="500" placeholder="상품에 대한 솔직한 후기를 남겨주세요. 최소 10자"></textarea>
                <div class="textarea-footer">
                    <span class="char-count" id="charCount">0/500</span>
                    <button id="saveBtn" class="save-btn" type="button">저장하기</button>
                </div>
                <div class="form-error" id="contentError">리뷰는 최소 10자 이상 입력해 주세요.</div>
                <div class="form-error" id="saveError"></div>
                <div class="hint">※ 구매한 상품(배송완료)만 리뷰 작성이 가능합니다. 이미 작성한 상품은 중복 작성할 수 없습니다.</div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{common/footer :: footer}"></div>

<!-- 외부 review-write.js 없이, 이 페이지에서 바로 저장까지 처리 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    (function () {
      const root = document.querySelector('main.container');
      if (!root) return;

      // 서버에서 전달된 값(없으면 data-*에서 읽음)
      const orderItemId = Number(/*[[${orderItemId}]]*/ null) || Number(root.dataset.orderItemId || 0);
      const productId   = Number(/*[[${productId}]]*/ null)   || Number(root.dataset.productId   || 0);

      const stars = Array.from(document.querySelectorAll('.star-rating .star'));
      const ratingInput = document.getElementById('ratingValue');
      const ratingError = document.getElementById('ratingError');

      const ta = document.getElementById('reviewTextarea');
      const charCount = document.getElementById('charCount');
      const contentError = document.getElementById('contentError');

      const saveBtn = document.getElementById('saveBtn');
      const saveError = document.getElementById('saveError');

      // 별점 클릭
      stars.forEach(el => {
        el.addEventListener('click', () => {
          const val = Number(el.getAttribute('data-rating') || '0');
          ratingInput.value = String(val);
          stars.forEach(s => {
            const r = Number(s.getAttribute('data-rating') || '0');
            s.classList.toggle('active', r <= val);
            s.setAttribute('aria-checked', r === val ? 'true' : 'false');
          });
          ratingError.style.display = 'none';
        });
      });

      // 글자수 카운트
      const updateCount = () => {
        const len = ta.value.length;
        charCount.textContent = `${len}/500`;
        if (len >= 10) contentError.style.display = 'none';
      };
      ta.addEventListener('input', updateCount);
      updateCount();

      // 저장 (시큐리티/CSRF 미사용 → 헤더에 CSRF 안 넣음)
      saveBtn.addEventListener('click', async () => {
        const rating  = Number(ratingInput.value || '0');
        const content = (ta.value || '').trim();

        let ok = true;
        if (rating < 1) { ratingError.style.display = 'block'; ok = false; }
        if (content.length < 10) { contentError.style.display = 'block'; ok = false; }
        if (!ok) return;

        saveBtn.disabled = true;
        saveError.style.display = 'none';
        saveError.textContent = '';

        try {
          const payload = { rating, content };
          if (orderItemId) payload.orderItemId = orderItemId;
          if (productId)   payload.productId   = productId;

          const res = await fetch('/api/my/reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            let msg = `저장 실패 (${res.status})`;
            try { msg = (await res.json()).message || msg; } catch (_) {}
            throw new Error(msg);
          }

          // 성공 시 목록으로 이동
          window.location.href = '/review';
        } catch (e) {
          saveError.textContent = e?.message || '오류가 발생했습니다.';
          saveError.style.display = 'block';
        } finally {
          saveBtn.disabled = false;
        }
      });
    })();
    /*]]>*/
</script>
</body>
</html>
