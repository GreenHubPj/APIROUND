<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>리뷰 작성 - GreenHub</title>

    <!-- CSRF (AJAX 저장 시 필요) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/review-write.css}" />

    <style>
        .container{max-width:1040px;margin:0 auto;padding:24px}
        .product-info-section{display:flex;gap:20px;margin-bottom:24px}
        .product-img{width:140px;height:140px;object-fit:cover;border-radius:12px;border:1px solid #eee}
        .product-info h1{margin:0 0 8px;font-size:22px}
        .product-price{margin-top:6px;color:#555}
        .review-textarea{width:100%;min-height:160px;padding:14px;border:1px solid #007bff;border-radius:10px}
        .textarea-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .save-btn{padding:.6rem 1.2rem;border-radius:10px;border:0;background:#007bff;color:#fff;cursor:pointer}
        .save-btn:disabled{opacity:.6;cursor:not-allowed}
        .star{font-size:24px;cursor:pointer;opacity:.35;user-select:none}
        .star.active{opacity:1}
        .error-box{background:#fff4f4;border:1px solid #ffd4d4;color:#b30000;padding:12px;border-radius:10px;margin:12px 0}
        .hint{color:#6c757d;margin:4px 0 0}
        .form-error{color:#b30000;margin-top:8px;display:none}
        .back-link{display:inline-block;margin:4px 0 16px;color:#1a73e8;text-decoration:none}
    </style>
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<main class="container"
      th:attr="data-order-item-id=${orderItemId}, data-product-id=${productId}">
    <a class="back-link" href="/review">← 리뷰 목록으로</a>

    <!-- 서버에서 온 에러(권한/조건 불일치 등) -->
    <div class="error-box" th:if="${errorMessage != null}" th:text="${errorMessage}">
        권한이 없거나 대상이 없습니다.
    </div>

    <section class="product-info-section" th:if="${errorMessage == null}">
        <div>
            <img class="product-img"
                 th:src="${productImage != null ? productImage : '/images/농산물.png'}"
                 th:alt="${productName != null ? productName : '상품 이미지'}"
                 alt="상품 이미지" />
        </div>
        <div class="product-info">
            <div class="store-brand" th:text="${storeName != null ? storeName : '스토어'}">스토어</div>
            <h1 class="product-name" th:text="${productName != null ? productName : '상품명'}">상품명</h1>
            <div class="product-price" th:text="${priceText != null ? priceText : ''}">-</div>
            <div class="hint" th:if="${deliveredAt != null}"
                 th:text="${'배송완료: ' + #temporals.format(deliveredAt, 'yyyy-MM-dd HH:mm')}">배송완료</div>
        </div>
    </section>

    <section class="review-write-section" th:if="${errorMessage == null}">
        <div class="satisfaction-section" aria-labelledby="ratingLabel">
            <h2 id="ratingLabel">상품 만족도</h2>
            <div class="star-rating" role="radiogroup" aria-label="별점 선택">
                <span class="star" data-rating="1" role="radio" aria-checked="false" aria-label="1점">★</span>
                <span class="star" data-rating="2" role="radio" aria-checked="false" aria-label="2점">★</span>
                <span class="star" data-rating="3" role="radio" aria-checked="false" aria-label="3점">★</span>
                <span class="star" data-rating="4" role="radio" aria-checked="false" aria-label="4점">★</span>
                <span class="star" data-rating="5" role="radio" aria-checked="false" aria-label="5점">★</span>
            </div>
            <input type="hidden" id="ratingValue" value="0" />
            <div class="form-error" id="ratingError">별점을 선택해 주세요.</div>
        </div>

        <div class="review-content-section">
            <h2>리뷰 작성</h2>
            <div class="review-textarea-container">
                <textarea id="reviewTextarea" class="review-textarea" maxlength="500" placeholder="상품에 대한 솔직한 후기를 남겨주세요. 최소 10자"></textarea>
                <div class="textarea-footer">
                    <span class="char-count" id="charCount">0/500</span>
                    <button id="saveBtn" class="save-btn" type="button">저장하기</button>
                </div>
                <div class="form-error" id="contentError">리뷰는 최소 10자 이상 입력해 주세요.</div>
                <div class="form-error" id="saveError"></div>
                <div class="hint">※ 구매한 상품(배송완료)만 리뷰 작성이 가능합니다. 이미 작성한 상품은 중복 작성할 수 없습니다.</div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{common/footer :: footer}"></div>

<script th:src="@{/js/review-write.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
      // 서버 렌더 데이터 → JS로 전달
      window.__REVIEW_WRITE__ = {
        orderItemId: /*[[${orderItemId}]]*/ null,
        productId:   /*[[${productId}]]*/ null,
        csrf: {
          token: /*[['']]*/ (document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''),
          header: /*[['']]*/ (document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || '')
        }
      };

      // 최소 동작 보장(별/글자수) — 별도의 review-write.js 가 있다면 중복되지 않게 가벼운 보조만 둡니다.
      (function () {
        const root = document.querySelector('main.container');
        if (!root) return;

        const stars = Array.from(document.querySelectorAll('.star-rating .star'));
        const ratingInput = document.getElementById('ratingValue');
        const ratingError = document.getElementById('ratingError');
        const ta = document.getElementById('reviewTextarea');
        const charCount = document.getElementById('charCount');
        const contentError = document.getElementById('contentError');

        // 별점 클릭
        stars.forEach(el => {
          el.addEventListener('click', () => {
            const val = Number(el.getAttribute('data-rating') || '0');
            ratingInput.value = String(val);
            stars.forEach(s => {
              const r = Number(s.getAttribute('data-rating') || '0');
              s.classList.toggle('active', r <= val);
              s.setAttribute('aria-checked', r === val ? 'true' : 'false');
            });
            ratingError.style.display = 'none';
          });
        });

        // 글자수
        if (ta && charCount) {
          const updateCount = () => {
            const len = ta.value.length;
            charCount.textContent = `${len}/500`;
            if (len >= 10) contentError.style.display = 'none';
          };
          ta.addEventListener('input', updateCount);
          updateCount();
        }

        // 저장 버튼: review-write.js 가 전송을 맡는 경우 여기서는 검증만
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => {
            const rating = Number(ratingInput?.value || '0');
            const content = (ta?.value || '').trim();

            let ok = true;
            if (rating < 1) { ratingError.style.display = 'block'; ok = false; }
            if (content.length < 10) { contentError.style.display = 'block'; ok = false; }

            // 검증만 통과시키고, 실제 저장은 review-write.js 에서 처리(예: /api/my/reviews POST)
            // 만약 review-write.js 가 없다면 여기에서 fetch로 구현하세요.
            if (!ok) return;

            // 이벤트를 커스텀으로 던져서 외부 스크립트가 수신해도 됨
            const ev = new CustomEvent('review:validated', {
              detail: {
                orderItemId: window.__REVIEW_WRITE__.orderItemId,
                productId: window.__REVIEW_WRITE__.productId,
                rating,
                content
              }
            });
            window.dispatchEvent(ev);
          });
        }
      })();
    /*]]>*/
</script>
</body>
</html>
