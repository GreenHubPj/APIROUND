<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품관리 - GreenHub</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/item-management.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 로그인 회사 ID를 메타로도 내려주면 JS가 백업으로 읽어감 -->
    <meta name="login-company-id" th:content="${loginCompany?.companyId}">
</head>
<body>
<!-- 헤더 -->
<div th:replace="common/header :: header"></div>

<div class="item-management-container">
    <div class="item-management-header">
        <h1>상품관리</h1>
        <p>지역별 특산품 게시글을 작성하고 관리하세요</p>
        <button type="button" class="btn-add-product" id="addProductBtn">+ 상품 추가</button>
    </div>

    <!-- 상품 등록/수정 폼 (product_listing 저장) -->
    <div class="item-form-section" id="itemFormSection" style="display:none;">
        <div class="form-header">
            <h2 id="formTitle">새 상품 등록</h2>
            <button type="button" class="btn-cancel" id="cancelBtn" style="display:none;">취소</button>
        </div>

        <!-- 백엔드 매핑: POST /item-management -->
        <form class="item-form" id="itemForm" method="post" th:action="@{/item-management}">
            <input type="hidden" name="_csrf" th:value="${_csrf?.token}">

            <!-- ✅ 로그인한 판매자: 서버에서 넣어줌 (필수) -->
            <input type="hidden" name="sellerId" id="sellerId" th:value="${loginCompany?.companyId}"/>
            <!-- 로그인 회사 정보를 메타 태그로 전달 -->
            <meta name="login-company-id" th:content="${loginCompany?.companyId}">

            <!-- ✅ price_value: 입력받지 않음. 제출 직전 옵션 최저가로 JS가 채움 -->
            <input type="hidden" name="priceValue" id="priceValue"/>

            <!-- (선택) 대표 옵션을 따로 지정하려면 인덱스 저장 (기본 0 = 첫 옵션) -->
            <input type="hidden" name="primaryOptionIndex" id="primaryOptionIndex" value="0"/>

            <!-- specialty_product 핵심 컬럼 -->
            <div class="form-group">
                <label class="form-label">상품명 *</label>
                <input type="text" class="form-input" name="productName" id="productName" placeholder="상품명" required>
            </div>

            <div class="form-group">
                <label class="form-label">상품 타입 *</label>
                <select class="form-select" name="productType" id="productType" required>
                    <option value="">선택하세요</option>
                    <option value="농산물">농산물</option>
                    <option value="수산물">수산물</option>
                    <option value="축산물">축산물</option>
                    <option value="가공식품">가공식품</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">지역 *</label>
                <input type="text" class="form-input" name="regionText" id="regionText" placeholder="예: 제주도, 경상북도 문경" required>
            </div>

            <div class="form-group">
                <label class="form-label">상품 설명 *</label>
                <textarea class="form-textarea" name="description" id="description" rows="4" placeholder="상품 설명" required></textarea>
            </div>

            <!-- 이미지 업로드 섹션 -->
            <div class="form-group">
                <label class="form-label">상품 이미지</label>
                <div class="image-upload-section">
                    <div class="image-preview-container" id="imagePreviewContainer">
                        <div class="image-preview" id="imagePreview">
                            <div class="image-placeholder">
                                <span class="upload-icon">📷</span>
                                <div>이미지를 업로드하세요</div>
                                <small>JPG, PNG, GIF 파일만 가능합니다</small>
                            </div>
                        </div>
                    </div>
                    <div class="upload-buttons">
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" multiple>
                        <button type="button" class="btn-upload" id="selectImageBtn">이미지 선택</button>
                        <button type="button" class="btn-remove-all" id="removeAllImagesBtn" style="display: none;">모든 이미지 삭제</button>
                    </div>
                </div>
                <input type="hidden" name="thumbnailUrl" id="thumbnailUrl">
            </div>

            <div class="form-group">
                <label class="form-label">제철기간 *</label>
                <div class="season-checkboxes">
                    <div class="checkbox-row">
                        <label class="checkbox-item"><input type="checkbox" name="months" value="1"><span class="checkmark"></span>1월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="2"><span class="checkmark"></span>2월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="3"><span class="checkmark"></span>3월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="4"><span class="checkmark"></span>4월</label>
                    </div>
                    <div class="checkbox-row">
                        <label class="checkbox-item"><input type="checkbox" name="months" value="5"><span class="checkmark"></span>5월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="6"><span class="checkmark"></span>6월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="7"><span class="checkmark"></span>7월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="8"><span class="checkmark"></span>8월</label>
                    </div>
                    <div class="checkbox-row">
                        <label class="checkbox-item"><input type="checkbox" name="months" value="9"><span class="checkmark"></span>9월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="10"><span class="checkmark"></span>10월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="11"><span class="checkmark"></span>11월</label>
                        <label class="checkbox-item"><input type="checkbox" name="months" value="12"><span class="checkmark"></span>12월</label>
                    </div>
                </div>
            </div>

            <!-- ✅ 가격 옵션 (product_price_option으로 저장) -->
            <div class="form-group">
                <label class="form-label">가격 옵션 *</label>
                <div class="price-options-container" id="priceOptionsContainer"><!-- JS가 첫 행 생성 --></div>
                <button type="button" class="btn-add-price" id="addPriceOption">가격 옵션 추가</button>
                <p class="help-text">최소 1개 옵션을 입력하세요. 제출 시 옵션 최저가가 price_value로 자동 반영됩니다.</p>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" id="resetBtn">초기화</button>
                <button type="submit" class="btn-primary" id="submitBtn">상품 등록</button>
            </div>
        </form>
    </div>

    <!-- 등록된 상품 목록 -->
    <div class="item-list-section">
        <div class="list-header">
            <h2>등록된 상품 목록</h2>
            <div class="list-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="제목으로 검색...">
                    <button type="button" id="searchBtn">검색</button>
                </div>
                <select id="filterStatus" class="filter-select">
                    <option value="">전체 상태</option>
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="PAUSED">PAUSED</option>
                    <option value="SOLDOUT">SOLDOUT</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table class="item-table">
                <thead>
                <tr>
                    <th class="id-col">ID</th>
                    <th class="title-col">제목</th>
                    <th class="status-col">상태</th>
                    <th class="price-col">대표가(원)</th>
                    <th class="date-col">등록일</th>
                    <th class="action-col">액션</th>
                </tr>
                </thead>
                <tbody id="itemTableBody">
                <tr th:if="${#lists.isEmpty(listings)}">
                    <td colspan="6" style="text-align:center;color:#777;">등록된 상품이 없습니다.</td>
                </tr>

                <tr th:each="l : ${listings}">
                    <td class="id-col" th:text="${l.listingId}">1</td>
                    <td class="title-col" th:text="${l.title}">제목</td>
                    <td class="status-col" th:text="${l.status}">ACTIVE</td>
                    <td class="price-col"
                        th:text="${l.priceValue} != null ? #numbers.formatDecimal(l.priceValue, 0, 'COMMA', 0, 'POINT') : '-'">0</td>
                    <td class="date-col"
                        th:text="${#temporals.format(l.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</td>
                    <td class="action-col">

                        <button type="button" class="btn-edit" th:onclick="'editListing(' + ${l.listingId} + ')'">수정</button>
                        <button type="button" class="btn-delete" th:onclick="'deleteListing(' + ${l.listingId} + ')'">삭제</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

<!-- 푸터 -->
<div th:replace="~{common/footer :: footer}"></div>

<script src="/js/item-management.js"></script>
</body>
</html>
